<%- include('../../partials/_header') %>

<main class="container mx-auto my-12 px-4">
  <article class="max-w-4xl mx-auto">
    <!-- Admin/Mod Controls -->
    <% if (user && (user.role === 'ADMIN' || user.role === 'MODERATOR')) { %>
      <div class="bg-yellow-100 dark:bg-gray-800 border-l-4 border-yellow-500 text-yellow-700 dark:text-yellow-300 p-4 rounded-md mb-6 flex justify-between items-center flex-wrap gap-4">
        <p class="font-bold">Admin/Mod Controls</p>
        <div class="flex items-center space-x-4">
           <!-- Edit Button -->
           <% if (user.id === article.authorId || user.role === 'ADMIN' || user.role === 'MODERATOR') { %>
            <a href="/articles/<%= article.slug %>/edit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition-colors text-sm">
              Edit
            </a>
          <% } %>

          <!-- Feature Button (Admin only) -->
          <% if (user.role === 'ADMIN') { %>
            <form action="/articles/<%= article.slug %>/toggle-feature" method="POST" class="inline">
              <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition-colors text-sm">
                <%= article.isFeatured ? 'Un-Feature' : 'Feature' %>
              </button>
            </form>
          <% } %>

           <!-- Hide/Unhide Button -->
           <form action="/articles/<%= article.slug %>/toggle-hidden" method="POST" class="inline">
            <button type="submit" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors text-sm">
              <%= article.hidden ? 'Unhide' : 'Hide' %>
            </button>
          </form>

        </div>
      </div>
    <% } %>

    <!-- Hidden Article Indicator -->
    <% if (article.hidden) { %>
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
        <strong class="font-bold">This article is hidden!</strong>
        <span class="block sm:inline"> It is not visible to regular users.</span>
      </div>
    <% } %>


    <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4"><%= article.title %></h1>
    
    <div class="flex items-center text-gray-600 dark:text-gray-400 mb-6">
      <span>By <%= article.author.name %></span>
      <span class="mx-2">&bull;</span>
      <span><%= new Date(article.createdAt).toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit',
                  timeZone: 'Africa/Nairobi' 
              }) %>
        </span>
       <span class="mx-2">&bull;</span>
      <span><%= article.viewCount %> views</span>
    </div>

    <!-- Edit Button -->
           <% if (!article.published && (user.id === article.authorId)) { %>
            <a href="/articles/<%= article.slug %>/edit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-md transition-colors text-sm">
              Edit
            </a>
          <% } %>

          <hr class="my-12 border-gray-300 dark:border-gray-700">

    <% if(article.headerImageUrl) { %>
      <img src="<%= article.headerImageUrl %>" alt="Header image for <%= article.title %>" class="w-full h-auto rounded-lg shadow-lg mb-8">
    <% } %>

    <!-- 
      The prose class now automatically applies all the great styling we defined in tailwind.config.js.
      We only need to keep the code block scrolling styles.
    -->
    <div class="prose prose-lg max-w-none dark:prose-invert
                prose-pre:max-h-[30rem] prose-pre:overflow-auto text-gray-800 dark:text-gray-200">
      <%- htmlContent %>
    </div>
    
    <hr class="my-12 border-gray-300 dark:border-gray-700">

    <!-- Comments Section -->
    <section>
        <h2 class="text-3xl font-bold mb-6 dark:text-white">Comments (<%= article.comments.length %>)</h2>

        <!-- Comment Form -->
         <% if (user) { %>
            <form action="/articles/<%= article.slug %>/comments" method="POST" class="mb-8">
                <textarea name="text" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-600 dark:text-white" placeholder="Write a comment..." required></textarea>
                <button type="submit" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition-colors">Post Comment</button>
            </form>
        <% } else { %>
            <p class="mb-8 text-gray-600 dark:text-gray-400">
                <a href="/login" class="text-blue-600 dark:text-blue-400 hover:underline">Log in</a> to post a comment.
            </p>
        <% } %>

        <!-- Existing Comments -->
        <div class="space-y-6">
            <% article.comments.forEach(comment => { %>
                <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm">
                    <p class="text-gray-800 dark:text-gray-200"><%= comment.text %></p>
                    <div class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                        <strong><%= comment.author.name %></strong> &bull; <%= new Date(comment.createdAt).toLocaleString() %>
                    </div>
                </div>
            <% }) %>
        </div>
    </section>

  </article>
</main>

<!-- ... existing content for show.ejs ... -->

  </article>
</main>

<!-- START OF NEW CODE: JSON-LD Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "<%= locals.seo.url %>"
  },
  "headline": "<%= article.title %>",
  "description": "<%= locals.seo.description %>",
  "image": "<%= locals.seo.image %>",  
  "author": {
    "@type": "Person",
    "name": "<%= locals.seo.authorName %>"
  },  
  "publisher": {
    "@type": "Organization",
    "name": "Artsy Thoughts",
    "logo": {
      "@type": "ImageObject",
      "url": "<%= process.env.BASE_URL %>/logo.png" 
    }
  },
  "datePublished": "<%= locals.seo.publishedDate %>",
  "dateModified": "<%= locals.seo.modifiedDate %>"
}
</script>
<!-- END OF NEW CODE -->




<%- include('../../partials/_footer') %>

