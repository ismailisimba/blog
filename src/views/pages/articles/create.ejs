<%- include('../../partials/_header', { user: user }) %>

<h2 class="text-2xl mb-6 px-6 text-gray-300">Create New Article</h2>
<!-- Add enctype here! -->
<form action="/articles" method="POST" enctype="multipart/form-data" class="dark:bg-gray-200 px-6 py-4 space-y-6">
  <div>
    <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
    <input type="text" name="title" id="title" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
  </div>

  <!-- Add this new file input -->
  <div>
    <label for="headerImage" class="block text-sm font-medium text-gray-700">Header Image</label>
    <input type="file" name="headerImage" id="headerImage" accept="image/*" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
  </div>

  <!-- Add this inside your form in both create.ejs and edit.ejs -->

<div class="mb-4">
    <label for="excerpt" class="block text-sm font-medium text-gray-700">Excerpt (for SEO & Previews)</label>
    <textarea id="excerpt" name="excerpt" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="A short, catchy summary... (max 160 characters recommended)"><%= typeof article !== 'undefined' ? article.excerpt : '' %></textarea>
</div>


  <div>
    <label for="content" class="block text-sm font-medium text-gray-700">Content</label>
    <textarea name="content" id="markdown-editor"></textarea>
  </div>
  <button type="submit" name="action" value="publish" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 ">Publish Article</button>
  <button type="submit" name="action" value="save_draft" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
    Save as Draft
  </button>
</form>

<script>
  function uploadFileAndInsertLink(file, editor) {
    const formData = new FormData();
    formData.append('file', file);

    fetch('/api/upload', {
      method: 'POST',
      body: formData,
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      const fileUrl = data.url;
      const cm = editor.codemirror;
      const doc = cm.getDoc();
      const cursor = doc.getCursor();

      // Check file extension to decide on link format
      const isImage = /\.(jpe?g|png|gif)$/i.test(fileUrl);
      let linkMarkdown;

      if (isImage) {
        // Insert image markdown
        linkMarkdown = `![${file.name}](${fileUrl})`;
      } else {
        // Insert standard link markdown for other files
        linkMarkdown = `[${file.name}](${fileUrl})`;
      }
      
      doc.replaceRange(linkMarkdown, cursor);
    })
    .catch(error => {
      console.error('Upload failed:', error);
      alert('File upload failed!');
    });
  }

  const easyMDE = new EasyMDE({
    element: document.getElementById('markdown-editor'),
    spellChecker: false,
    // Enable image handling
    uploadImage: true,
    // Define our custom uploader
    imageUploadFunction: (file, onSuccess, onError) => {
      // EasyMDE's API is designed for a success callback, but our fetch logic handles it.
      // We'll wrap our function to fit this.
      uploadFileAndInsertLink(file, easyMDE);
      // We call onSuccess to prevent EasyMDE from showing its own error message.
      onSuccess("upload handled by custom function"); 
    },
    // Custom handler for pasting files
    previewClass: ["editor-preview", "prose", "lg:prose-xl"],
    // You might need to add other options here from your previous setup
  });

  // Add a paste event listener for more robust file handling
  easyMDE.codemirror.on('paste', (cm, event) => {
    const items = (event.clipboardData || event.originalEvent.clipboardData).items;
    for (const item of items) {
      if (item.kind === 'file') {
        event.preventDefault();
        const file = item.getAsFile();
        uploadFileAndInsertLink(file, easyMDE);
      }
    }
  });
</script>


<%- include('../../partials/_footer') %>
