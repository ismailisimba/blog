<%- include('../../partials/_header', { user: user }) %>

<div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-md">
  <h2 class="text-2xl mb-6 px-6 text-gray-300">Edit Article</h2>
  
  <%# The form action now points to the update route with the method override %>
  <form action="/articles/<%= article.slug %>?_method=PUT" method="POST" class="dark:bg-gray-200 px-6 py-4 space-y-6">
    <div>
      <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
      <%# Pre-populate the value attribute %>
      <input type="text" name="title" id="title" required value="<%= article.title %>" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
    </div>
    
    <%# Note: We are not including the file upload on the edit page for simplicity. %>
    <%# Adding "edit image" functionality requires more complex logic. %>

    <div>
      <label for="content" class="block text-sm font-medium text-gray-700">Content</label>
      <%# Pre-populate the content between the textarea tags %>
      <textarea name="content" id="markdown-editor"><%= article.content %></textarea>
    </div>
    
    <button type="submit" name="action" value="publish" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 ">Publish Article</button>
  <button type="submit" name="action" value="save_draft" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
    Save as Draft
  </button>
  </form>
</div>

<script>
  function uploadFileAndInsertLink(file, editor) {
    const formData = new FormData();
    formData.append('file', file);

    fetch('/api/upload', {
      method: 'POST',
      body: formData,
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      const fileUrl = data.url;
      const cm = editor.codemirror;
      const doc = cm.getDoc();
      const cursor = doc.getCursor();

      // Check file extension to decide on link format
      const isImage = /\.(jpe?g|png|gif)$/i.test(fileUrl);
      let linkMarkdown;

      if (isImage) {
        // Insert image markdown
        linkMarkdown = `![${file.name}](${fileUrl})`;
      } else {
        // Insert standard link markdown for other files
        linkMarkdown = `[${file.name}](${fileUrl})`;
      }
      
      doc.replaceRange(linkMarkdown, cursor);
    })
    .catch(error => {
      console.error('Upload failed:', error);
      alert('File upload failed!');
    });
  }

  const easyMDE = new EasyMDE({
    element: document.getElementById('markdown-editor'),
    spellChecker: false,
    // Enable image handling
    uploadImage: true,
    // Define our custom uploader
    imageUploadFunction: (file, onSuccess, onError) => {
      // EasyMDE's API is designed for a success callback, but our fetch logic handles it.
      // We'll wrap our function to fit this.
      uploadFileAndInsertLink(file, easyMDE);
      // We call onSuccess to prevent EasyMDE from showing its own error message.
      onSuccess("upload handled by custom function"); 
    },
    // Custom handler for pasting files
    previewClass: ["editor-preview", "prose", "lg:prose-xl"],
    // You might need to add other options here from your previous setup
  });

  // Add a paste event listener for more robust file handling
  easyMDE.codemirror.on('paste', (cm, event) => {
    const items = (event.clipboardData || event.originalEvent.clipboardData).items;
    for (const item of items) {
      if (item.kind === 'file') {
        event.preventDefault();
        const file = item.getAsFile();
        uploadFileAndInsertLink(file, easyMDE);
      }
    }
  });
</script>


<%- include('../../partials/_footer') %>
